{"version":3,"sources":["../../src/datasource.js"],"names":["DynatraceDatasource","instanceSettings","$q","backendSrv","templateSrv","type","name","q","id","jsonData","token","url","headers","Authorization","options","datasourceRequest","doRequest","then","status","message","title","catch","targets","_","filter","target","hide","fromTs","range","from","_d","getTime","toTs","to","requests","Object","keys","forEach","t","opts","method","data","aggregationType","aggregation","endTimestamp","startTimestamp","timeseriesId","all","results","metrics","r","regexp","RegExp","m","processDatapoints","result","concat","test","serie","dimension","relativeTime","res","entities","pickBy","startsWith","key","map","d","i","text","value","getTsNames","query","entry","item","dataPoints","tsid","label","dp","x","identifiers","split","push","datapoints"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\n\nexport default class DynatraceDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.q = $q;\n\n    this.id = instanceSettings.jsonData.id;\n    this.token = instanceSettings.jsonData.token;\n\n    this.url = `${instanceSettings.url}/e/${this.id}/api/v1/timeseries`;\n\n    this.headers = { Authorization: `Api-Token ${this.token}` };\n\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  doRequest(options) {\n    options.url = this.url;\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  testDatasource() {\n    return this.doRequest({}).then(() => ({\n      status: 'success', message: 'Data source is working', title: 'Success',\n    })).catch(() => ({\n      status: 'error', message: 'Datasource test failed', title: 'Error',\n    }));\n  }\n\n  query(options) {\n    const targets = _.filter(options.targets, (target => !target.hide));\n    const fromTs = options.range.from._d.getTime();\n    const toTs = options.range.to._d.getTime();\n    const requests = [];\n\n    Object.keys(targets).forEach((t) => {\n      const opts = {\n        method: 'POST',\n        data: {\n          aggregationType: targets[t].aggregation,\n          endTimestamp: toTs,\n          startTimestamp: fromTs,\n          timeseriesId: targets[t].target,\n        },\n      };\n      requests[t] = this.doRequest(opts);\n    });\n\n    // TODO: this throws an error when one of the requests fails\n    // Would be better to finish all requests which do work\n    return this.q.all(requests).then((results) => {\n      let metrics = [];\n\n      Object.keys(results).forEach((r) => {\n        const regexp = new RegExp(targets[r].filter);\n        const m = DynatraceDatasource.processDatapoints(results[r].data.result);\n\n        metrics = metrics.concat(_.filter(m, serie => regexp.test(serie.target)));\n      });\n\n      return { data: metrics };\n    }).catch(() => ({\n      data: [], // TODO: Handle properly\n    }));\n  }\n\n  static processDatapoints(result) {\n    const r = [];\n\n    Object.keys(result.dataPoints).forEach((tsid) => {\n      let label = '';\n      const dp = result.dataPoints[tsid].map(x => [x[1], x[0]]);\n      const identifiers = tsid.split(', ');\n\n      Object.keys(identifiers).forEach((id) => {\n        label += `${result.entities[identifiers[id]]} `;\n      });\n\n      r.push({\n        target: label,\n        datapoints: dp,\n      });\n    });\n\n    return r;\n  }\n\n  getEntities(target, dimension) {\n    const options = {\n      method: 'POST',\n      data: {\n        aggregationType: 'AVG',\n        relativeTime: 'hour',\n        timeseriesId: target,\n      },\n    };\n\n    return this.doRequest(options).then((res) => {\n      const entities = _.pickBy(res.data.result.entities, key =>\n        (_.startsWith(key, dimension)));\n\n      return _.map(entities, (d, i) => (\n        { text: d, value: i }\n      ));\n    });\n  }\n\n  metricFindQuery() {\n    // var interpolated = {\n    //     target: this.templateSrv.replace(query, null, 'regex')\n    // };\n\n    return this.doRequest({\n      method: 'GET',\n    }).then(DynatraceDatasource.getTsNames);\n  }\n\n  metricFindDetails(query) {\n    // TODO: Don't do a new request but take results from findquery\n    return this.doRequest({\n      method: 'GET',\n    }).then((res) => {\n      const entry = _.filter(res.data, item =>\n        (item.timeseriesId === query))[0];\n\n      return entry;\n    }).catch(() => (false));\n  }\n\n  static getTsNames(result) {\n    return _.map(result.data, d => (\n      { text: d.timeseriesId, value: d.timeseriesId }));\n  }\n}\n\n"]}